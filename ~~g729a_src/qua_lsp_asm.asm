	.mmregs
FP	.set	AR7
	.sect	".text"
	.global	_Lsp_pre_select
	
;***************************************************************
;* FUNCTION DEF: _Lsp_pre_select                               *
;***************************************************************
_Lsp_pre_select:

        PSHM      AR1
        PSHM      AR6
        PSHM      AR7
        FRAME     #-8
        STLM      A,AR7              ; (ar7)= rbuf
        LD        *SP(12),A          ; sp(12) = lspcb1
        STL       A,*SP(2)           ; sp(2) = lspcb1
        MVDK      *SP(13),*(AR6)     ; (ar6) = cand
        LD        #0,A
        ST        #0,*AR6            ; *cand = 0
        STL       A,*SP(3)           ; sp(3) = 0 
        ;RSBX      OVM
        NOP
        LD        #32767,16,A           
        OR        #65535,A,A          ; (a) = 0x7FFFFFFF
        DST       A,*SP(4)            ;  sp(4) = MAX_32

;----------------------------------------------------------------------
; 151 | for ( i = 0 ; i < NC0 ; i++ ) {                                        
;----------------------------------------------------------------------
        STM       #0,AR1
        SSBX      SXM                   ; line-81
        SSBX      OVM                   ; line-85
        SSBX      FRCT                  ; line-95
        ORM       #2,*(PMST)
        LD        *SP(2),B            ; (b) = lspcb1
        LD        *SP(3),A
        ADD       *(BL),A             ; (a) = lspcb1 + sp(3)
        STLM      A,AR4               ; (ar3) = lspcb1 + sp(3)
L1:    
        ;LD        *SP(2),B            ; (b) = lspcb1
        ;LD        *SP(3),A
        ;ADD       *(BL),A             ; (a) = lspcb1 + sp(3)
        ;STLM      A,AR3               ; (ar3) = lspcb1 + sp(3)
        MVMM      AR4,AR3
        MVMM      AR7,AR2             ; (ar2) = rbuf
;----------------------------------------------------------------------
; 152 | L_tmp = 0;                                                             
; 153 | for ( j = 0 ; j < M ; j++ ) {                                          
; 154 |   tmp = sub(rbuf[j], lspcb1[i][j]);                                    
;----------------------------------------------------------------------
        STM       #9,BRC
        LD        #0,A
        ;LD        #0,B                  ; ADDED BY D.L.B
        ;DST       A,*SP(6)              ; sp(6) = L_tmp 
        ;DLD       *SP(6),B              ; ****
        LD         A,B
        ;ORM       #2,*(PMST)            ; line-97
        RPTB      LOOP_1-1
L2:    
;----------------------------------------------------------------------
; 155 | L_tmp = L_mac( L_tmp, tmp, tmp );                                      
;----------------------------------------------------------------------
        LD         *AR2+,A
        SUB        *AR3+,A,A
        STLM      A,T                   ; (T) = tmp
        MAC       *(AL), B              ; (b) =  L_mac(L_tmp,tmp,tmp)
LOOP_1:
        DST       B,*SP(6)              
L3:    
;----------------------------------------------------------------------
; 158 | L_temp = L_sub(L_tmp,L_dmin);                                          
; 159 | if (  L_temp< 0L) {                                                    
;----------------------------------------------------------------------
        DLD       *SP(4),A         
        DRSUB      *SP(6),A                
        BC        L4,AGEQ              
;----------------------------------------------------------------------
; 160 | L_dmin = L_tmp;                                                        
;----------------------------------------------------------------------
        DLD       *SP(6),A              ; sp(6) = L_tmp
        DST       A,*SP(4)              ; sp(4) = L_dmin = L_tmp
        MVKD      *(AR1),*AR6           ; (ar6) = cand = i
L4:     
        ;LD        *SP(3),A
        MAR       *AR1+                 ; (ar1) = i = i++
        ;ADD       #10,A
        ;STL       A,*SP(3)
        MAR       *+AR4(10)
   
        LD        *(AR1),A            
        SUB       #128,A,A              
        BC        L1,ALT   
                    
        ANDM      #-833,*(ST1)
        ANDM      #-4,*(PMST)
        FRAME     #8
        POPM      AR7
        POPM      AR6
        POPM      AR1
        RET


	.sect	".text"
	.global	_Lsp_select_1
	
;***************************************************************
;* FUNCTION DEF: _Lsp_select_1                                 *
;***************************************************************

_Lsp_select_1:

        PSHM      AR1
        PSHM      AR6
        PSHM      AR7
        FRAME     #-18
        STLM      A,AR3            ; (ar3) = rbuf
        STM       #4,BRC
        MVMM      SP,AR1           
        MAR       *+AR1(#2)        ; (ar1) = buf = sp+2
        LD        *SP(23),B        ; (b) = sp(23) = wegt
        MVDK      *SP(22),*(AR2)   ; (ar2) = lspcb1
        MVDK      *SP(25),*(AR6)   ; (ar6) = index
        MVDK      *SP(24),*(AR7)   ; (ar7) = lspcb2
        STL       B,*SP(12)        ; sp(12) = wegt
        SSBX      SXM              ; added by d.l.b
        SSBX      OVM
        RPTB      L6-1
L5:    
;----------------------------------------------------------------------
; 185 | buf[j] = sub(rbuf[j], lspcb1[j]);                                      
;----------------------------------------------------------------------
        LD        *AR3+,16,A           
        SUB       *AR2+,16,A,A          
        STH       A,*AR1+              
L6:    
;----------------------------------------------------------------------
; 188 | *index = 0;                                                            
;----------------------------------------------------------------------
        LD        #0,A
        ST        #0,*AR6               ; (ar6) = index
        STL       A,*SP(13)
;----------------------------------------------------------------------
; 189 | L_dmin = MAX_32;                                                       
;----------------------------------------------------------------------
        ;RSBX      OVM
        ;NOP
        LD        #32767,16,A           
        OR        #65535,A,A            
        DST       A,*SP(14)             ; sp(14) = L_dmin
        STM       #0,AR1
        SSBX      FRCT                  ; line-205
        ;SSBX      OVM                   ; line-199

        ORM       #2,*(PMST)            ; line-216
L7:    
        LD        *SP(13),A             
        ADD       *(AR7),A              ; (a) point to lspcb2[][5] (ar7) = lspcb2
        MVMM      SP,AR3
        STLM      A,AR4                 ; (ar4) = lspcb2[][5]
        MAR       *+AR3(#2)             ; (ar3) = buf
        MVDK      *SP(12),*(AR2)        ; (ar2) = wegt
;----------------------------------------------------------------------
; 191 | L_dist = 0;                                                            
; 192 | for ( j = 0 ; j < NC ; j++ ) {                                         
; 193 |   tmp = sub(buf[j], lspcb2[k1][j]);                                    
; 194 |   tmp2 = mult( wegt[j], tmp );                                         
;----------------------------------------------------------------------
        STM       #4,BRC
        LD        #0,A
        DST       A,*SP(16)             ; sp(16) is a temporary L_dist

        RPTB      L9-1
L8:    
;----------------------------------------------------------------------
; 195 | L_dist = L_mac( L_dist, tmp2, tmp );                                   
;----------------------------------------------------------------------
        LD        *AR3+,16,A            ; (a) = buf[j]  
        SUB       *AR4+,16,A,A          ; (ar4) = lspcb2
        
        ;SFTA      A,-16,A               ; (a) = tmp = sub(buf[j], lspcb2[k1][j])
        ;STLM      A,AR5                 ; (ar5) = tmp
        ;LD        *(AR5),16,A           
        STH       A,*(AR5)
        
        MPYA      *AR2+                 ; (b) = tmp2 = mult( wegt[j], tmp )
        STH       B,*(T)                ; (T) = tmp2
        DLD       *SP(16),A             ; (a) = L_dist 
        MAC       *(AR5), A             ; (a) =  L_dist = L_mac( L_dist, tmp2, tmp )
        DST       A,*SP(16)             ; sp(16) = L_dist 
L9:    
;----------------------------------------------------------------------
; 198 | L_temp =L_sub(L_dist,L_dmin);                                          
; 199 | if ( L_temp <0L ) {                                                    
;----------------------------------------------------------------------
        ;RSBX      OVM
        ;NOP
        DLD       *SP(14),A
        ;RSBX      FRCT
        ;DST       A,*SP(0)               
        ;DLD       *SP(16),A             
        ;CALL      #_L_sub              
        DRSUB     *SP(16),A
        ;RSBX      OVM
        ;SSBX      SXM
        ;SFTA      A,8                   
        ;SFTA      A,-8                  
        BC        L10,AGEQ             
;----------------------------------------------------------------------
; 200 | L_dmin = L_dist;                                                       
;----------------------------------------------------------------------
        DLD       *SP(16),A
        DST       A,*SP(14)             ; sp(14) = L_dmin 
;----------------------------------------------------------------------
; 201 | *index = k1;                                                           
;----------------------------------------------------------------------
        MVKD      *(AR1),*AR6
L10:    
;----------------------------------------------------------------------
; 204 | return;                                                                
;----------------------------------------------------------------------
        LD        *SP(13),A
        MAR       *AR1+
        ADD       #10,A
        STL       A,*SP(13)
        LD        *(AR1),A             
        SUB       #32,A,A              
        BC        L7,ALT               

        ANDM      #-833,*(ST1)
        ANDM      #-4,*(PMST)
        FRAME     #18
        POPM      AR7
        POPM      AR6
        POPM      AR1
        RET


	.sect	".text"
	.global	_Lsp_select_2

;***************************************************************
;* FUNCTION DEF: _Lsp_select_2                                 *
;***************************************************************

_Lsp_select_2:
        PSHM      AR1
        PSHM      AR6
        PSHM      AR7
        FRAME     #-18
        RSBX      OVM
        NOP
        ADD       #5,A,A
        STM       #4,BRC
        MVMM      SP,AR1
        STLM      A,AR3
        LD        *SP(23),B
        MAR       *+AR1(#7)
        STL       B,*SP(12)
        MVDK      *SP(25),*(AR6)
        LD        *SP(22),B
        MVDK      *SP(24),*(AR7)
        ADD       #5,B,B
        STLM      B,AR2
        SSBX      SXM              ; added by d.l.b
        SSBX      OVM              ; added by d.l.b
        RPTB      L12-1
L11:    
        LD        *AR3+,16,A            
        SUB       *AR2+,16,A,A          
        STH       A,*AR1+               
L12:    
;----------------------------------------------------------------------
; 228 | *index = 0;                                                            
;----------------------------------------------------------------------
        LD        #5,A
        ST        #0,*AR6              
        STL       A,*SP(13)
;----------------------------------------------------------------------
; 229 | L_dmin = MAX_32;                                                       
;----------------------------------------------------------------------
        RSBX      OVM
        NOP
        LD        #32767,16,A           ; |229| 
        OR        #65535,A,A            ; |229| 
        DST       A,*SP(14)             ; |229| 
;----------------------------------------------------------------------
; 230 | for ( k1 = 0 ; k1 < NC1 ; k1++ ) {                                     
;----------------------------------------------------------------------
        STM       #0,AR1
        SSBX      FRCT                  ; line-205
        SSBX      OVM                   ; line-199
        ORM       #2,*(PMST)            ; line-216  
L13:    
        LD        *SP(13),A
        ADD       *(AR7),A
        STLM      A,AR3
        LD        *SP(12),A
        MVMM      SP,AR2
        ADD       #5,A,A
        STLM      A,AR4
        MAR       *+AR2(#7)
;----------------------------------------------------------------------
; 231 | L_dist = 0;                                                            
; 232 | for ( j = NC ; j < M ; j++ ) {                                         
; 233 |   tmp = sub(buf[j], lspcb2[k1][j]);                                    
; 234 |   tmp2 = mult( wegt[j], tmp );                                         
;----------------------------------------------------------------------
        STM       #4,BRC
        LD        #0,A
        DST       A,*SP(16) 
        
        RPTB      L15-1

L14:    
;----------------------------------------------------------------------
; 235 | L_dist = L_mac( L_dist, tmp2, tmp );                                   
;----------------------------------------------------------------------
        ;RSBX      OVM
        ;SSBX      SXM
        ;NOP
        LD        *AR2+,16,A            
        ;SSBX      OVM
        ;NOP
        SUB       *AR3+,16,A,A          ; (a) = tmp = sub(buf[j], lspcb2[k1][j])
        ;SFTA      A,-16,A               
        ;RSBX      OVM
        ;STLM      A,AR5
        ;SSBX      FRCT
        ;LD        *(AR5),16,A    
        STH       A,*(AR5)     
        ;SSBX      OVM
        ;NOP
        MPYA      *AR4+                 
        ;RSBX      OVM
        STH       B,*(T)
        DLD       *SP(16),A             
        ;ORM       #2,*(PMST)
        ;SSBX      OVM
        ;ORM       #2,*(PMST)
        MAC       *(AR5), A             
        DST       A,*SP(16)            

L15:    
;----------------------------------------------------------------------
; 238 | L_temp = L_sub(L_dist, L_dmin);                                        
; 239 | if ( L_temp <0L ) {                                                    
;----------------------------------------------------------------------
        ;RSBX      OVM
        ;NOP
        DLD       *SP(14),A
        ;RSBX      FRCT
        ;DST       A,*SP(0)            
        ;DLD       *SP(16),A            
        ;CALL      #_L_sub 
        DRSUB     *SP(16),A             
        ;RSBX      OVM
        ;SSBX      SXM
        ;SFTA      A,8                   
        ;SFTA      A,-8                  
        BC        L16,AGEQ              
;----------------------------------------------------------------------
; 240 | L_dmin = L_dist;                                                       
;----------------------------------------------------------------------
        DLD       *SP(16),A
        DST       A,*SP(14)             ; |240| 
;----------------------------------------------------------------------
; 241 | *index = k1;                                                           
;----------------------------------------------------------------------
        MVKD      *(AR1),*AR6
L16:    
;----------------------------------------------------------------------
; 244 | return;                                                                
;----------------------------------------------------------------------
        LD        *SP(13),A
        MAR       *AR1+
        ADD       #10,A
        STL       A,*SP(13)
        LD        *(AR1),A              ; |243| 
        SUB       #32,A,A               ; |243| 
        BC        L13,ALT               ; |243| 
        ANDM      #-833,*(ST1)
        ANDM      #-4,*(PMST)
        FRAME     #18
        POPM      AR7
        POPM      AR6
        POPM      AR1
        RET

	.sect	".text"
	.global	_Lsp_get_tdist
;----------------------------------------------------------------------
; 137 | void Lsp_get_tdist(                                                    
; 138 | Word16 wegt[],        /* (i) norm: weight coef.                */      
; 139 | Word16 buf[],         /* (i) Q13 : candidate LSP vector        */      
; 140 | Word32 *L_tdist,      /* (o) Q27 : distortion                  */      
; 141 | Word16 rbuf[],        /* (i) Q13 : target vector               */      
; 142 | Word16 fg_sum[]       /* (i) Q15 : present MA prediction coef. */      
; 143 | )                                                                      
;----------------------------------------------------------------------

_Lsp_get_tdist:

        PSHM      AR1
        PSHM      AR6
        PSHM      AR7
        FRAME     #-6
        ;NOP
        SSBX      SXM      ; ****
        SSBX      OVM
        SSBX      FRCT
;----------------------------------------------------------------------
; 145 | Word16 j;                                                              
; 146 | Word16 tmp, tmp2;     /* Q13 */                                        
; 147 | Word32 L_acc;         /* Q25 */                                        
;----------------------------------------------------------------------
        MVDK      *SP(12),*(AR2)
        MVDK      *SP(10),*(AR1)
        MVDK      *SP(11),*(AR6)
        MVDK      *SP(13),*(AR3)
;----------------------------------------------------------------------
; 149 | *L_tdist = 0;                                                          
; 150 | for ( j = 0 ; j < M ; j++ ) {                                          
;----------------------------------------------------------------------
        LD        #0,B
        STLM      A,AR7
        LD        #10,A
        DST       B,*AR6                ; |149| 
        STL       A,*SP(4)
        MVKD      *(AR2),*SP(3)
        MVKD      *(AR3),*SP(2)
L17:    
;----------------------------------------------------------------------
; 152 | tmp = sub( buf[j], rbuf[j] );                                          
; 153 | tmp = mult( tmp, fg_sum[j] );                                          
; 156 | L_acc = L_mult( wegt[j], tmp );                                        
;----------------------------------------------------------------------
        ;RSBX      OVM
        ;SSBX      SXM
        MVDK      *SP(3),*(AR2)
        LD        *AR1+,16,A            ; |152| 
        ;SSBX      OVM
        ;SSBX      FRCT
        SUB       *AR2+,16,A,A          ; |152| 
        ;RSBX      OVM
        MVKD      *(AR2),*SP(3)
        STH       A,*(T)
        MVDK      *SP(2),*(AR2)
        LD        *AR2+,16,A            ; |152| 
        ;SSBX      OVM
        NOP
        MPYA      A                     ; |152| 
        SFTA      A,-16,A               ; |152| 
        STL       A,*SP(5)
        MVKD      *(AR2),*SP(2)

;----------------------------------------------------------------------
; 157 | tmp2 = extract_h( L_shl( L_acc, 4 ) );                                 
;----------------------------------------------------------------------
        STLM      A,T
        ;ST        #4,*SP(0)             ; |157| 
        NOP
        MPY       *AR7+,A               ; |157| 
        ;RSBX      FRCT
        ;RSBX      OVM
        NOP
        ;CALL      #_L_shl               ; |157| 
        SFTA      A,4
        
        SFTL      A,#-16,A              ; |157| 
        STLM      A,T

;----------------------------------------------------------------------
; 158 | *L_tdist = L_mac( *L_tdist, tmp2, tmp );                               
;----------------------------------------------------------------------
        ;SSBX      SXM
        ;NOP
        DLD       *AR6,A
        LD        *SP(5),B
        ORM       #2,*(PMST)
        ;SSBX      FRCT
        ;SSBX      OVM
        ;ORM       #2,*(PMST)
        MAC       *(BL), A              ; |158| 
        DST       A,*AR6                ; |158| 

;----------------------------------------------------------------------
; 161 | return;                                                                
;----------------------------------------------------------------------
        MVDK      *SP(4),*(AR2)
        BANZD     L17,*+AR2(-1)          ; |159| 
        MVKD      *(AR2),*SP(4)

        ANDM      #-833,*(ST1)
        ANDM      #-4,*(PMST)
        FRAME     #6
        POPM      AR7
        POPM      AR6
        POPM      AR1
        RET

	.sect	".text"
	.global	_Lsp_last_select
;----------------------------------------------------------------------
; 166 | void Lsp_last_select(                                                  
; 167 | Word32 L_tdist[],     /* (i) Q27 : distortion         */               
; 168 | Word16 *mode_index    /* (o)     : the selected mode  */               
; 169 | )                                                                      
;----------------------------------------------------------------------
_Lsp_last_select:

        PSHM      AR1
        ;FRAME     #-2
        SSBX      SXM
        SSBX      OVM
;----------------------------------------------------------------------
; 171 | Word32 L_temp;                                                         
;----------------------------------------------------------------------
        MVDK      *SP(2),*(AR1)
        STLM      A,AR2

;----------------------------------------------------------------------
; 172 | *mode_index = 0;                                                       
;----------------------------------------------------------------------
        ST        #0,*AR1               ; |172| 

;----------------------------------------------------------------------
; 173 | L_temp =L_sub(L_tdist[1] ,L_tdist[0]);                                 
; 174 | if (  L_temp<0L){                                                      
;----------------------------------------------------------------------
        ;DLD       *AR2,A                ; |173| 
        ;DST       A,*SP(0)              ; |173| 
        DLD       *AR2(2),A             ; |173| 
        ;CALL      #_L_sub               ; |173| 
        DSUB      *AR2,A
        
        ;SSBX      SXM
        ;SFTA      A,8                   ; |173| 
        ;SFTA      A,-8                  ; |173| 
        BC        L18,AGEQ               ; |173| 

;----------------------------------------------------------------------
; 175 | *mode_index = 1;                                                       
; 177 | return;                                                                
;----------------------------------------------------------------------
        ST        #1,*AR1               ; |175| 
L18:    
        ;FRAME     #2
        POPM      AR1
        RET      
  
	.sect	".text"
	.global	_Get_wegt

;----------------------------------------------------------------------
; 180 | void Get_wegt(                                                         
; 181 | Word16 flsp[],    /* (i) Q13 : M LSP parameters  */                    
; 182 | Word16 wegt[]     /* (o) Q11->norm : M weighting coefficients */       
; 183 | )                                                                      
;----------------------------------------------------------------------

_Get_wegt:

        PSHM      AR1
        PSHM      AR6
        PSHM      AR7
        FRAME     #-14
;----------------------------------------------------------------------
; 185 | Word16 i;                                                              
; 186 | Word16 tmp;                                                            
; 187 | Word32 L_acc;                                                          
; 188 | Word16 sft;                                                            
; 189 | Word16 buf[M]; /* in Q13 */                                            
;----------------------------------------------------------------------
        STLM      A,AR2
        LD        *SP(18),A
        STL       A,*SP(12)

;----------------------------------------------------------------------
; 192 | buf[0] = sub( flsp[1], (PI04+8192) );           /* 8192:1.0(Q13) */    
; 194 | for ( i = 1 ; i < M-1 ; i++ ) {                                        
; 195 |   tmp = sub( flsp[i+1], flsp[i-1] );                                   
;----------------------------------------------------------------------
        ;RSBX      OVM
        SSBX      FRCT
        SSBX      OVM
        SSBX      SXM
        STM       #7,BRC
        MVMM      AR2,AR3
        MVMM      SP,AR1
        LD        *AR2(1),16,A          ; |192| 
        ;SSBX      OVM
        MAR       *+AR1(#3)
        SUB       #9221,16,A,A          ; |192| 
        STH       A,*SP(2)              ; |192| 
        RPTB      L20-1
        
L19:    
;----------------------------------------------------------------------
; 196 | buf[i] = sub( tmp, 8192 );                                             
;----------------------------------------------------------------------
        ;RSBX      OVM
        LD        *AR3(2),16,A          ; |196| 
        ;SSBX      OVM
        ;NOP
        SUB       *AR3,16,A,A           ; |196| 
        SUB       #8192,16,A,A          ; |196| 
        STH       A,*AR1+               ; |196| 
        MAR       *AR3+
        
L20:    
;----------------------------------------------------------------------
; 199 | buf[M-1] = sub( (PI92-8192), flsp[M-2] );                              
; 202 | for ( i = 0 ; i < M ; i++ ) {                                          
;----------------------------------------------------------------------
        ;RSBX      OVM
        MVMM      SP,AR6
        STM       #10,AR7
        LD        #15485,16,A           ; |199| 
        MVDK      *SP(12),*(AR1)
        ;SSBX      OVM
        MAR       *+AR6(#1)
        SUB       *AR2(8),16,A,A        ; |199| 
        STH       A,*SP(11)             ; |199| 
L21:    

;----------------------------------------------------------------------
; 203 | if ( buf[i] > 0 ){                                                     
; 204 |   wegt[i] = 2048;                    /* 2048:1.0(Q11) */               
; 206 | else {                                                                 
; 207 |   L_acc = L_mult( buf[i], buf[i] );           /* L_acc in Q27 */       
;----------------------------------------------------------------------
        LD        *+AR6(1),A
        BC        L22,AGT               ; |203| 
;----------------------------------------------------------------------
; 208 | tmp = extract_h( L_shl( L_acc, 2 ) );       /* tmp in Q13 */           
; 210 | L_acc = L_mult( tmp, CONST10 );             /* L_acc in Q25 */         
;----------------------------------------------------------------------
        ;SSBX      FRCT
        STLM      A,T
        MPY       *(AL),A               ; |208| 
        ;RSBX      OVM
        ;RSBX      FRCT
        ;ST        #2,*SP(0)             ; |208| 
        ;CALL      #_L_shl               ; |208| 
        SFTA      A,2
        
        SFTL      A,#-16,A              ; |208| 

;----------------------------------------------------------------------
; 211 | tmp = extract_h( L_shl( L_acc, 2 ) );       /* tmp in Q11 */           
;----------------------------------------------------------------------
        ;SSBX      FRCT
        ;SSBX      OVM
        MPY       *(AL),#20480,A        ; |211| 
        ;RSBX      FRCT
        ;RSBX      OVM
        ;ST        #2,*SP(0)             ; |211| 
        ;CALL      #_L_shl               ; |211| 
        SFTA      A,2
        
        SFTL      A,#-16,A              ; |211| 

;----------------------------------------------------------------------
; 213 | wegt[i] = add( tmp, 2048 );                 /* wegt in Q11 */          
;----------------------------------------------------------------------
        ;SSBX      SXM
        ;RSBX      OVM
        LD        *(AL),16,A            ; |213| 
        ;SSBX      OVM
        ;NOP
        ADD       #2048,16,A,A          ; |213| 
        BD        L23                   ; |213| 
        NOP
        STH       A,*AR1                ; |213| 
       
L22:    
        ST        #2048,*AR1            ; |204| 
L23:    
;----------------------------------------------------------------------
; 218 | L_acc = L_mult( wegt[4], CONST12 );             /* L_acc in Q26 */     
;----------------------------------------------------------------------
        BANZD     L21,*+AR7(-1)         ; |215| 
        NOP
        MAR       *AR1+

;----------------------------------------------------------------------
; 219 | wegt[4] = extract_h( L_shl( L_acc, 1 ) );       /* wegt in Q11 */      
; 221 | L_acc = L_mult( wegt[5], CONST12 );             /* L_acc in Q26 */     
;----------------------------------------------------------------------
        ;ST        #1,*SP(0)            
        ;SSBX      FRCT
        MVDK      *SP(12),*(AR1)
        MPY       *AR1(4),#19661,A      
        ;RSBX      OVM
        ;RSBX      FRCT
        NOP
        ;CALL      #_L_shl              
        SFTA      A,1
        
        SFTL      A,#-16,A              
        STL       A,*AR1(4)             
;----------------------------------------------------------------------
; 222 | wegt[5] = extract_h( L_shl( L_acc, 1 ) );       /* wegt in Q11 */      
;----------------------------------------------------------------------
        ;SSBX      FRCT
        ;SSBX      OVM
        ;ST        #1,*SP(0)             ; |222| 
        MPY       *AR1(5),#19661,A      ; |222| 
        ;RSBX      FRCT
        ;RSBX      OVM
        NOP
        ;CALL      #_L_shl              
        SFTA      A,1
        
        SFTL      A,#-16,A              ; |222| 
        STL       A,*AR1(5)             ; |222| 

;----------------------------------------------------------------------
; 225 | tmp = 0;                                                               
; 226 | for ( i = 0; i < M; i++ ) {                                            
;----------------------------------------------------------------------
        LD        #0,B
        STM       #9,BRC
        RPTB      L26-1
       
L24:    
;----------------------------------------------------------------------
; 227 | if ( sub(wegt[i], tmp) > 0 ) {                                         
;----------------------------------------------------------------------
        ;RSBX      OVM
        ;SSBX      SXM
        MVDK      *AR1+,*(AR2)
        LD        *(AR2),16,A           ; |227| 
        ;SSBX      OVM
        SUB       *(BL),16,A,A          ; |227| 
        SFTA      A,-16,A               ; |227| 
        LD        *(AL),A               ; |227| 
        BC        L25,ALEQ              ; |227| 
;----------------------------------------------------------------------
; 228 | tmp = wegt[i];                                                         
;----------------------------------------------------------------------
        LDM       AR2,B
L25:    
        NOP
L26:    
;----------------------------------------------------------------------
; 232 | sft = norm_s(tmp);                                                     
; 233 | for ( i = 0; i < M; i++ ) {                                            
;----------------------------------------------------------------------
        ;RSBX      OVM
        ;SSBX      SXM
        LD        *(BL),16,A            ; |232| 
        STM       #10,AR7
        EXP       A                     ; |232| 
        MVDK      *SP(12),*(AR1)
        MVMD      T,AR6
L27:    
;----------------------------------------------------------------------
; 234 | wegt[i] = shl(wegt[i], sft);                  /* wegt in Q(11+sft) */  
;----------------------------------------------------------------------
        MVKD      *(AR6),*SP(0)
        ;RSBX      FRCT
        ;RSBX      OVM
        LD        *AR1,A
        CALL      #_shl              
        
        STL       A,*AR1+
;----------------------------------------------------------------------
; 237 | return;                                                                
;----------------------------------------------------------------------
        BANZ      L27,*+AR7(-1)         

        ANDM      #-833,*(ST1)
        ANDM      #-4,*(PMST)
        FRAME     #14
        POPM      AR7
        POPM      AR6
        POPM      AR1
        RET
 
        .global _shl