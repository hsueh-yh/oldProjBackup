	.mmregs
FP	.set	AR7
	.sect	".text"
	.global	_Pitch_ol_fast
;----------------------------------------------------------------------
;  29 | Word16 Pitch_ol_fast(  /* output: open loop pitch lag
;     |       */                                                               
;  30 | Word16 signal[],    /* input : signal used to compute the open loop pit
;     | ch */                                                                  
;  32 | Word16   pit_max,   /* input : maximum pitch lag
;     |    */                                                                  
;  33 | Word16   L_frame    /* input : length of frame to compute pitch
;     |    */                                                                  
;  34 | )                                                                      
;----------------------------------------------------------------------
_Pitch_ol_fast:

        PSHM      AR1
        ;RSBX      OVM
        PSHM      AR6
        PSHM      FP
        ADDM      #-246,*(SP)
        NOP
        NOP
        MVMM      SP,FP
        STLM      A,AR1                ; ar1 = signal[]
        LD        *FP(251),A
        STL       A,*FP(235)           ; fp(235) = L_frame
        LD        *FP(250),B           ; b = pit_max
;----------------------------------------------------------------------
;  48 | scal_sig = &scaled_signal[pit_max];                                    
;----------------------------------------------------------------------
        LDM       SP,A
        ADD       #12,A
        ADD       B,A                   
        STL       A,*FP(236)           ; sp(236) = scaled_signal

;----------------------------------------------------------------------
;  64 | if(Verifi_Overflow(0,signal,signal,-pit_max,L_frame,2,&sum) == 1)      
;  66 |   for(i=-pit_max; i<L_frame; i++)                                      
;  68 |     scal_sig[i] = shr(signal[i], 3);                                   
;  71 | else {                                                                 
;----------------------------------------------------------------------
        ;RSBX      FRCT
        MVKD      *(AR1),*SP(0)
        NEG       B,A                   
        MVKD      *(AR1),*SP(1)
        STL       A,*FP(237)          ; sp(237) = -pit_max
        STL       A,*SP(2)
        LD        *FP(235),A
        STL       A,*SP(3)
        LDM       SP,A
        ADD       #10,A
        ST        #2,*SP(4)             
        STL       A,*SP(5)            ; sp(10) = sum
        CALLD     #_Verifi_Overflow      
        NOP
        LD        #0,A
        
        ;RSBX      OVM
        SSBX      SXM
        LD        *(AL),A
        SUB       #1,A,A               
        BC        L5,AEQ              ; if( Overflow ) goto L5             

;----------------------------------------------------------------------
;  72 | L_temp = L_sub(sum, (Word32)1048576L);                                 
;  73 | if ( L_temp < (Word32)0 )  /* if (sum < 2^20) */                       
;  75 |    for(i=-pit_max; i<L_frame; i++)                                     
;  77 |      scal_sig[i] = shl(signal[i], 3);                                  
;  80 | else                                                                   
;----------------------------------------------------------------------
        SSBX      OVM                ; ****  SXM = 1
        ;LD        #16,16,A  
        LD        #16,16,B            
        ;RSBX      FRCT
        ;DST       A,*SP(0)              
        DLD       *SP(10),A             
        ;CALL      #_L_sub               
        SUB       B, A              ; a = L_sub(sum, (Word32)1048576L)
        
        ;RSBX      OVM
        ;SSBX      SXM
        ;SFTA      A,8                   
        ;SFTA      A,-8          

        BC        L3,ALT             ; if ( a<0 ) goto L3          

;----------------------------------------------------------------------
;  82 | for(i=-pit_max; i<L_frame; i++)                                        
;----------------------------------------------------------------------
        LD        *FP(235),B         ; b = L_frame
        LD        *FP(237),A         ; a = -pit_max
        SUB       *(BL),A            ; a = L_frame - (-pit_max)          
        BC        L7,AGEQ            ; if( a >= 0 ) goto L7

        LD        *FP(237),A         ; a = -pit_max
        ADD       *(AR1),A           ; a = signal[i]
        MVDK      *FP(236),*(AR2)    ; fp(236) = ar2 = scaled_signal[]
        STLM      A,AR3              ; ar3 = signal[i]
        LD        *FP(237),A
        ADD       *(AR2),A
        STLM      A,AR2              ; ar2 = scaled_signal[i]
        LD        B,A
        LD        *FP(237),B
        SUB       B,A
        SUB       #1,A
        STLM      A,BRC
        NOP
        RPTB      L2-1
L1:    
        MVDD      *AR3+,*AR2+        ; scal_sig[i] = signal[i]     
L2:    
        B         L7                  
L3:    
        LD        *FP(235),B         ; b = L_frame
        LD        *FP(237),A         ; a = -pit_max
        SUB       *(BL),A            
        BC        L7,AGEQ            ; if( a >= 0 ) goto L7         

        LD        *FP(237),A
        ADD       *(AR1),A
        MVDK      *FP(236),*(AR2)
        STLM      A,AR1
        LD        *FP(237),A
        ADD       *(AR2),A
        STLM      A,AR6
        LD        B,A
        LD        *FP(237),B
        SUB       B,A
        STL       A,*FP(238)
;        MVDK      *FP(238),*(AR2)    ; ****
        STLM      A,AR2    ; ****
L4:    

        ;ST        #3,*SP(0)             
        ;RSBX      FRCT
        ;RSBX      OVM
        LD        *AR1+,A
        ;CALL      #_clshft   
        SFTA      A,3                  
        NOP
        STL       A,*AR6+
        ;MVDK      *FP(238),*(AR2)
        MAR       *+AR2(#-1)
        ;MVKD      *(AR2),*FP(238)
        BANZ      L4,*AR2 
        MVKD      *(AR2),*FP(238)     ; ****              
        B         L7                    
   
L5:    
        LD        *FP(235),B           ; b = L_frame
        LD        *FP(237),A           ; a = -pit_max
        SUB       *(BL),A               
        BC        L7,AGEQ               
        LD        *FP(237),A           ; fp(237) = i
        ADD       *(AR1),A             ; ar1 = signal[]
        MVDK      *FP(236),*(AR2)      ; ar2 = scaled_signal
        STLM      A,AR1                ; ar1 = signal[i]
        LD        *FP(237),A
        ADD       *(AR2),A
        STL       A,*FP(238)           ; fp(238) = scaled_signal[i]
        LD        B,A
        LD        *FP(237),B
        SUB       B,A
        ;STLM      A,AR6
  
        SUB       #1,A
        STLM      A,BRC
        MVDK      *FP(238),*(AR2)      ; ****
        NOP
        RPTB      LOOP1-1                
L6:    

        ;ST        #3,*SP(0)             
        ;RSBX      FRCT
        ;RSBX      OVM
        LD        *AR1+,A
        ;CALL      #_shr              
        SFTA      A,-3                 ; ****
        
        
        ;MVDK      *FP(238),*(AR2)
        STL       A,*AR2+
        ;MVKD      *(AR2),*FP(238)

        ;BANZ      L6,*+AR6(-1) 
LOOP1:        
	    MVKD      *(AR2),*FP(238)      ; **** 
L7:      
        ;05.24 15:19  
        ;RSBX      OVM
        LD        *FP(236),A
        SUB       #20,A,A
        STLM      A,AR6                ; ar6 = scal_sig[-i]
;----------------------------------------------------------------------
; 102 | max = MIN_32;                                                          
;----------------------------------------------------------------------
        ;SSBX      SXM
        ;NOP
        LD        #-32768,16,A          
        DST       A,*FP(240)           ; sp(240) = max = MIN_32

;----------------------------------------------------------------------
; 103 | T1  = 20;    /* Only to remove warning from some compilers */          
;----------------------------------------------------------------------
        LD        #20,A
        STL       A,*FP(242)           ; sp(242) = T1
;----------------------------------------------------------------------
; 104 | for (i = 20; i < 40; i++) {                                            
;----------------------------------------------------------------------
        STM       #20,AR1
L8:    
        MVDK      *FP(236),*(AR2)      ; ar2 = p = scal_sig
        MVMM      AR6,AR3              ; ar3 = ar6 = scal_sig[-i]
        LD        #0,A
        DST       A,*SP(10)            ; sp(10) = sum   

;----------------------------------------------------------------------
; 108 | for (j=0; j<L_frame; j+=2, p+=2, p1+=2)                                
;----------------------------------------------------------------------
        LD        *FP(235),A
        BC        L10,ALEQ             ; if( a <=0 ) goto L10            

        ;LD        *FP(235),A           ; a = L_frame
        ADD       #1,A,A
        ;LD        *(AL),A
        SFTA      A,#-1,A
        SUB       #1,A
        STLM      A,BRC                ; brc = (L_frame+1)/2-1
        ;SSBX      OVM
        ORM       #2,*(PMST)
        DLD       *SP(10),A
        NOP
        RPTB      LOOP2-1

L9:    
;----------------------------------------------------------------------
; 109 | sum = L_mac(sum, *p, *p1);                                             
;----------------------------------------------------------------------
        ;DLD       *SP(10),A             
        ;ORM       #2,*(PMST)
        ;SSBX      FRCT
        ;SSBX      OVM
        ;ORM       #2,*(PMST)
        ;NOP
        MAC       *AR3, *AR2, A, A      
        MAR       *+AR3(#2)
        MAR       *+AR2(#2)
        ;DST       A,*SP(10)             
LOOP2:
	    DST       A,*SP(10)            ; sp(10) = sum
L10:    

;----------------------------------------------------------------------
; 110 | L_temp = L_sub(sum, max);                                              
;----------------------------------------------------------------------
        ;RSBX      OVM
        ;DLD       *FP(240),A
        ;RSBX      FRCT
        ;DST       A,*SP(0)              
        DLD       *SP(10),A             
        ;CALL      #_L_sub               
        DSUB      *FP(240),A
        
        
        ;RSBX      OVM
        ;SSBX      SXM
        ;SFTA      A,8                   
        ;SFTA      A,-8                  
        BC        L11,ALEQ              

;----------------------------------------------------------------------
; 111 | if (L_temp > 0) { max = sum; T1 = i;   }                               
;----------------------------------------------------------------------
        DLD       *SP(10),A             
        MVKD      *(AR1),*FP(242)         ; T1 = i
        DST       A,*FP(240)               
L11:    

        MAR       *AR1+
        LD        *(AR1),A              
        SUB       #40,A,A               
        BCD       L8,ALT                  ; end of (for(i=20;i<40;i++))
                        
        NOP
        MAR       *AR6-

        LD        #1,A
        DST       A,*SP(10)               ; sp(10) = sum = 1

        LD        *FP(242),B
        LD        *FP(236),A
        SUB       B,A                   
        STLM      A,AR1                   ; ar1 = p = &scal_sig[-T1];  

;----------------------------------------------------------------------
; 118 | for(i=0; i<L_frame; i+=2, p+=2)                                        
;----------------------------------------------------------------------
        LD        *FP(235),A
        BC        L13,ALEQ             

        ;LD        *FP(235),A
        ADD       #1,A,A
        LD        *(AL),A
        SFTA      A,#-1,A
        SUB       #1,A
        STLM      A,BRC
        SSBX      FRCT          ; ****
        ;SSBX      OVM           ; ****
        ORM       #2,*(PMST)    ; ****
        DLD       *SP(10),A     ; ****
        NOP
        RPTB      L13-1
L12:    
;----------------------------------------------------------------------
; 119 | sum = L_mac(sum, *p, *p);                                              
;----------------------------------------------------------------------
        LD        *AR1,B
        ;DLD       *SP(10),A            
        STLM      B,T
        ;ORM       #2,*(PMST)
        ;SSBX      FRCT
        ;SSBX      OVM
        ;ORM       #2,*(PMST)
        MAR       *+AR1(#2)
        MAC       *(BL), A              
        ;DST       A,*SP(10)   
LOOP3:          
		DST       A,*SP(10)  
L13:    

;----------------------------------------------------------------------
; 124 | sum = Inv_sqrt(sum);            /* 1/sqrt(energy),    result in Q30 */ 
;----------------------------------------------------------------------
        RSBX      OVM
        RSBX      FRCT
        DLD       *SP(10),A             
        CALL      #_Inv_sqrt            
        ; OVM = SXM = FRCT = 0
        DST       A,*SP(10)             

;----------------------------------------------------------------------
; 125 | L_Extract(max, &max_h, &max_l);                                        
;----------------------------------------------------------------------
        ;RSBX      OVM
        LDM       SP,A
        ADD       #6,A
        STL       A,*SP(0)
        ;LDM       SP,A
        ;ADD       #7,A
        ADD       #1,A               ; ****
        
        STL       A,*SP(1)
        ;RSBX      FRCT
        DLD       *FP(240),A            
        CALL      #_L_Extract           

;----------------------------------------------------------------------
; 126 | L_Extract(sum, &ener_h, &ener_l);                                      
;----------------------------------------------------------------------
        ;RSBX      OVM
        LDM       SP,A
        ADD       #8,A
        STL       A,*SP(0)
        ;LDM       SP,A
        ;ADD       #9,A
        ADD       #1,A
        STL       A,*SP(1)
        ;RSBX      FRCT
        DLD       *SP(10),A             
        CALL      #_L_Extract           

;----------------------------------------------------------------------
; 127 | sum  = Mpy_32(max_h, max_l, ener_h, ener_l);                           
;----------------------------------------------------------------------
        LD        *SP(7),A
        STL       A,*SP(0)
        LD        *SP(8),A
        STL       A,*SP(1)
        LD        *SP(9),A
        STL       A,*SP(2)
        ;RSBX      FRCT
        ;RSBX      OVM
        LD        *SP(6),A
        CALL      #_Mpy_32             
        
        DST       A,*SP(10)            

;----------------------------------------------------------------------
; 128 | max1 = extract_l(sum);                                                 
;----------------------------------------------------------------------
        LD        *SP(11),A
        STL       A,*FP(238)
        ;RSBX      OVM
        LD        *FP(236),A
        SUB       #40,A,A
        STLM      A,AR6                ; ar6 = scal_sig[-40]

;----------------------------------------------------------------------
; 132 | max = MIN_32;                                                          
;----------------------------------------------------------------------
        SSBX      SXM
        NOP
        LD        #-32768,16,A          
        DST       A,*FP(240)            

;----------------------------------------------------------------------
; 133 | T2  = 40;    /* Only to remove warning from some compilers */          
;----------------------------------------------------------------------
        LD        #40,A
        STL       A,*FP(243)            ; sp(243) = 40 = T2

;----------------------------------------------------------------------
; 134 | for (i = 40; i < 80; i++) {                                            
;----------------------------------------------------------------------
        STM       #40,AR1
        SSBX      FRCT      ; ****
        SSBX      OVM       ; ****
        ORM       #2,*(PMST)
L14:    

;----------------------------------------------------------------------
; 135 | p  = scal_sig;                                                         
;----------------------------------------------------------------------
        MVDK      *FP(236),*(AR2)
        MVMM      AR6,AR3
        LD        #0,A
        DST       A,*SP(10)            

;----------------------------------------------------------------------
; 138 | for (j=0; j<L_frame; j+=2, p+=2, p1+=2)                                
;----------------------------------------------------------------------
        LD        *FP(235),A
        BC        L16,ALEQ              ; |138| 

        ;LD        *FP(235),A
        ADD       #1,A,A
        ;LD        *(AL),A
        SFTA      A,#-1,A
        SUB       #1,A          ; ****
        STLM      A,BRC
        ;SSBX      SXM
        ;SSBX      FRCT
        ;SSBX      OVM
        ;ORM       #2,*(PMST)
        DLD       *SP(10),A     ; ****
        NOP
        RPTB      LOOP11-1
        
L15:    
;----------------------------------------------------------------------
; 139 | sum = L_mac(sum, *p, *p1);                                             
;----------------------------------------------------------------------
        ;DLD       *SP(10),A             
        ;ORM       #2,*(PMST)
        ;SSBX      FRCT
        ;SSBX      OVM
        ;ORM       #2,*(PMST)
        ;NOP
        MAC       *AR3, *AR2, A, A      
        MAR       *+AR3(#2)
        MAR       *+AR2(#2)
        ;DST       A,*SP(10)             
LOOP11:
        DST       A,*SP(10) 
L16:    
;----------------------------------------------------------------------
; 140 | L_temp = L_sub(sum, max);                                              
;----------------------------------------------------------------------

        ;RSBX      OVM
        ;DLD       *FP(240),A
        ;RSBX      FRCT
        ;DST       A,*SP(0)              
        DLD       *SP(10),A             
        ;CALL      #_L_sub               
        DSUB      *FP(240),A
        
        ;RSBX      OVM
        ;SSBX      SXM
        ;SFTA      A,8                   
        ;SFTA      A,-8                  
        BC        L17,ALEQ              

;----------------------------------------------------------------------
; 141 | if (L_temp > 0) { max = sum; T2 = i;   }                               
;----------------------------------------------------------------------
        DLD       *SP(10),A             
        MVKD      *(AR1),*FP(243)
        DST       A,*FP(240)            
L17:    

        MAR       *AR1+
        LD        *(AR1),A               
        SUB       #80,A,A               
        BCD       L14,ALT               
        NOP
        MAR       *AR6-

;----------------------------------------------------------------------
; 146 | sum = 1;                   /* to avoid division by zero */             
;----------------------------------------------------------------------
        LD        #1,A
        DST       A,*SP(10)             

;----------------------------------------------------------------------
; 147 | p = &scal_sig[-T2];                                                    
;----------------------------------------------------------------------
        LD        *FP(243),B
        LD        *FP(236),A
        SUB       B,A                    
        STLM      A,AR1

;----------------------------------------------------------------------
; 148 | for(i=0; i<L_frame; i+=2, p+=2)                                        
;----------------------------------------------------------------------
        LD        *FP(235),A
        BC        L19,ALEQ              ; |148| 

        ;LD        *FP(235),A
        ADD       #1,A,A
        LD        *(AL),A
        SFTA      A,#-1,A
        SUB       #1,A
        STLM      A,BRC
        NOP
        ;FRCT = OVM = SXM = SMUL =1
        RPTB      LOOP12-1
        
L18:    

;----------------------------------------------------------------------
; 149 | sum = L_mac(sum, *p, *p);                                              
;----------------------------------------------------------------------
        LD        *AR1,B
        ;DLD       *SP(10),A            
        STLM      B,T
        ;ORM       #2,*(PMST)
        ;SSBX      FRCT
        ;SSBX      OVM
        ;ORM       #2,*(PMST)
        MAR       *+AR1(#2)
        MAC       *(BL), A              
        ;DST       A,*SP(10)            
LOOP12:
        DST       A,*SP(10)  
L19:    

;----------------------------------------------------------------------
; 154 | sum = Inv_sqrt(sum);            /* 1/sqrt(energy),    result in Q30 */ 
;----------------------------------------------------------------------
        RSBX      OVM
        RSBX      FRCT
        DLD       *SP(10),A            
        CALL      #_Inv_sqrt           

        DST       A,*SP(10)             

;----------------------------------------------------------------------
; 155 | L_Extract(max, &max_h, &max_l);                                        
;----------------------------------------------------------------------
        ;RSBX      OVM
        LDM       SP,A
        ADD       #6,A
        STL       A,*SP(0)
        ;LDM       SP,A
        ;ADD       #7,A
        ADD       #1,A
        STL       A,*SP(1)
        ;RSBX      FRCT
        DLD       *FP(240),A            
        CALL      #_L_Extract           
  
;----------------------------------------------------------------------
; 156 | L_Extract(sum, &ener_h, &ener_l);                                      
;----------------------------------------------------------------------
        ;RSBX      OVM
        LDM       SP,A
        ADD       #8,A
        STL       A,*SP(0)
        ;LDM       SP,A
        ;ADD       #9,A
        ADD       #1,A
        STL       A,*SP(1)
        ;RSBX      FRCT
        DLD       *SP(10),A             
        CALL      #_L_Extract          

;----------------------------------------------------------------------
; 157 | sum  = Mpy_32(max_h, max_l, ener_h, ener_l);                           
;----------------------------------------------------------------------
        LD        *SP(7),A
        STL       A,*SP(0)
        LD        *SP(8),A
        STL       A,*SP(1)
        LD        *SP(9),A
        STL       A,*SP(2)
        ;RSBX      FRCT
        ;RSBX      OVM
        LD        *SP(6),A
        CALL      #_Mpy_32              
       
        DST       A,*SP(10)             

;----------------------------------------------------------------------
; 158 | max2 = extract_l(sum);                                                 
;----------------------------------------------------------------------
        LD        *SP(11),A
        STL       A,*FP(237)
        ;RSBX      OVM
        LD        *FP(236),A
        SUB       #80,A,A
        STLM      A,AR6

;----------------------------------------------------------------------
; 162 | max = MIN_32;                                                          
;----------------------------------------------------------------------
        SSBX      SXM
        NOP
        LD        #-32768,16,A         
        DST       A,*FP(240)            

;----------------------------------------------------------------------
; 163 | T3  = 80;    /* Only to remove warning from some compilers */          
;----------------------------------------------------------------------
        LD        #80,A
        STL       A,*FP(244)

;----------------------------------------------------------------------
; 164 | for (i = 80; i < 143; i+=2) {                                          
;----------------------------------------------------------------------
        STM       #80,AR1
        SSBX      FRCT
        SSBX      OVM
        ORM       #2,*(PMST)
L20:    
        MVDK      *FP(236),*(AR2)
        MVMM      AR6,AR3
        LD        #0,A
        DST       A,*SP(10)             

;----------------------------------------------------------------------
; 168 | for (j=0; j<L_frame; j+=2, p+=2, p1+=2)                                
;----------------------------------------------------------------------
        LD        *FP(235),A
        BC        L22,ALEQ              

        ;LD        *FP(235),A
        ADD       #1,A,A
        LD        *(AL),A
        SFTA      A,#-1,A
        SUB       #1,A
        STLM      A,BRC
        DLD       *SP(10),A   
        ;SSBX      SXM          
        ;SSBX      FRCT
        ;SSBX      OVM
        ;ORM       #2,*(PMST)
        ;NOP
        RPTB      LOOP21-1
L21:    
;----------------------------------------------------------------------
; 169 | sum = L_mac(sum, *p, *p1);                                             
;----------------------------------------------------------------------
        ;DLD       *SP(10),A             
        ;ORM       #2,*(PMST)
        ;SSBX      FRCT
        ;SSBX      OVM
        ;ORM       #2,*(PMST)
        ;NOP
        MAC       *AR3, *AR2, A, A      
        MAR       *+AR3(#2)
        MAR       *+AR2(#2)
        ;DST       A,*SP(10)             
LOOP21:
		DST       A,*SP(10)
L22:    
;----------------------------------------------------------------------
; 170 | L_temp = L_sub(sum, max);                                              
;----------------------------------------------------------------------
        ;RSBX      OVM
        ;DLD       *FP(240),A
        ;RSBX      FRCT
        ;DST       A,*SP(0)              
        DLD       *SP(10),A             
        ;CALL      #_L_sub               
        DSUB      *FP(240),A
             
        ;RSBX      OVM
        ;SSBX      SXM
        ;SFTA      A,8                   
        ;SFTA      A,-8                 
        BC        L23,ALEQ              

;----------------------------------------------------------------------
; 171 | if (L_temp > 0) { max = sum; T3 = i;   }                               
;----------------------------------------------------------------------
        DLD       *SP(10),A             
        MVKD      *(AR1),*FP(244)
        DST       A,*FP(240)            
L23:    

        MAR       *+AR1(#2)
        LD        *(AR1),A              
        SUB       #143,A,A              
        BCD       L20,ALT      
         
        MAR       *+AR6(#-2)
;----------------------------------------------------------------------
; 176 | i = T3;                                                                
;----------------------------------------------------------------------
        MVDK      *FP(244),*(AR1)       ; sp(244) = T3 = ar1 = i
;----------------------------------------------------------------------
; 177 | p  = scal_sig;                                                         
;----------------------------------------------------------------------
        MVDK      *FP(236),*(AR2)
;----------------------------------------------------------------------
; 178 | p1 = &scal_sig[-(i+1)];                                                
;----------------------------------------------------------------------
        LDM       AR1,A                 
        ADD       #1,A,B                
        LDM       AR2,A
        SUB       B,A                    
        STLM      A,AR3                 ; ar3 = p1

;----------------------------------------------------------------------
; 179 | sum = 0;                                                               
;----------------------------------------------------------------------
        LD        #0,A
        DST       A,*SP(10)             ; |179| 

;----------------------------------------------------------------------
; 180 | for (j=0; j<L_frame; j+=2, p+=2, p1+=2)                                
;----------------------------------------------------------------------
        LD        *FP(235),A
        BC        L25,ALEQ              ; |180| 

        ;LD        *FP(235),A
        ADD       #1,A,A
        LD        *(AL),A
        SFTA      A,#-1,A
        SUB       #1,A
        STLM      A,BRC
        DLD       *SP(10),A        ; ****
        NOP
        RPTB      LOOP22-1
        
L24:    
;----------------------------------------------------------------------
; 181 | sum = L_mac(sum, *p, *p1);                                             
;----------------------------------------------------------------------
        ;DLD       *SP(10),A             
        ;ORM       #2,*(PMST)
        ;SSBX      FRCT
        ;SSBX      OVM
        ;ORM       #2,*(PMST)
        ;NOP
        MAC       *AR3, *AR2, A, A      
        MAR       *+AR3(#2)
        MAR       *+AR2(#2)
        ;DST       A,*SP(10)             
LOOP22:
  		DST       A,*SP(10)    
L25:    
;----------------------------------------------------------------------
; 182 | L_temp = L_sub(sum, max);                                              
;----------------------------------------------------------------------
        ;RSBX      OVM
        ;DLD       *FP(240),A
        ;RSBX      FRCT
        ;DST       A,*SP(0)              
        DLD       *SP(10),A             
        ;CALL      #_L_sub               
        DSUB      *FP(240),A
        
        ;RSBX      OVM
        ;SSBX      SXM
        ;SFTA      A,8                   
        ;SFTA      A,-8                  
        BC        L26,ALEQ              

;----------------------------------------------------------------------
; 183 | if (L_temp > 0) { max = sum; T3 = i+(Word16)1;   }                     
;----------------------------------------------------------------------
        DLD       *SP(10),A             
        DST       A,*FP(240)            
        LDM       AR1,A
        ADD       #1,A,A                
        STL       A,*FP(244)
L26:    

;----------------------------------------------------------------------
; 185 | p  = scal_sig;                                                         
;----------------------------------------------------------------------
        ; OVM = FRCT = SXM = 1
        MVDK      *FP(236),*(AR2)

;----------------------------------------------------------------------
; 186 | p1 = &scal_sig[-(i-1)];                                                
;----------------------------------------------------------------------
        LDM       AR1,A
        SUB       #1,A,A                
        STLM      A,AR1
        NOP
        LDM       AR1,B
        LDM       AR2,A
        SUB       B,A                   
        STLM      A,AR3                ; ar3 = p1 = &scal_sig[-(i-1)]

;----------------------------------------------------------------------
; 187 | sum = 0;                                                               
;----------------------------------------------------------------------
        LD        #0,A
        DST       A,*SP(10)             

;----------------------------------------------------------------------
; 188 | for (j=0; j<L_frame; j+=2, p+=2, p1+=2)                                
;----------------------------------------------------------------------
        LD        *FP(235),A
        BC        L28,ALEQ              ; |188| 

        ;LD        *FP(235),A
        ADD       #1,A,A
        LD        *(AL),A
        SFTA      A,#-1,A
        SUB       #1,A
        STLM      A,BRC
        DLD       *SP(10),A

        ;SSBX      FRCT                  ; ****
        ;SSBX      OVM                   ; ****
        ;ORM       #2,*(PMST)            ; ****
        ;NOP
        RPTB      LOOP31-1
        
L27:    
;----------------------------------------------------------------------
; 189 | sum = L_mac(sum, *p, *p1);                                             
;----------------------------------------------------------------------
        ;DLD       *SP(10),A              
        ;ORM       #2,*(PMST)
        ;SSBX      FRCT
        ;SSBX      OVM
        ;ORM       #2,*(PMST)
        ;NOP
        MAC       *AR3, *AR2, A, A       
        MAR       *+AR3(#2)
        MAR       *+AR2(#2)
        ;DST       A,*SP(10)             
LOOP31:
        DST       A,*SP(10) 
L28:    
;----------------------------------------------------------------------
; 190 | L_temp = L_sub(sum, max);                                              
;----------------------------------------------------------------------
        ;RSBX      OVM
        ;DLD       *FP(240),A
        ;RSBX      FRCT
        ;DST       A,*SP(0)              
        DLD       *SP(10),A             
        ;CALL      #_L_sub               
        DSUB      *FP(240),A
        
        ;RSBX      OVM
        ;SSBX      SXM
        ;SFTA      A,8                   
        ;SFTA      A,-8                  
        BC        L29,ALEQ              

;----------------------------------------------------------------------
; 191 | if (L_temp > 0) { max = sum; T3 = i-(Word16)1;   }                     
;----------------------------------------------------------------------
        DLD       *SP(10),A             
        MVKD      *(AR1),*FP(244)
        DST       A,*FP(240)            
L29:    
;----------------------------------------------------------------------
; 195 | sum = 1;                   /* to avoid division by zero */             
;----------------------------------------------------------------------
        LD        #1,A
        DST       A,*SP(10)             

;----------------------------------------------------------------------
; 196 | p = &scal_sig[-T3];                                                    
;----------------------------------------------------------------------
        LD        *FP(244),B
        LD        *FP(236),A
        SUB       B,A                   
        STLM      A,AR1             ; ar1 = p 
;----------------------------------------------------------------------
; 197 | for(i=0; i<L_frame; i+=2, p+=2)                                        
;----------------------------------------------------------------------
        LD        *FP(235),A
        BC        L31,ALEQ             
     
        ADD       #1,A,A
        LD        *(AL),A
        SFTA      A,#-1,A
        SUB       #1,A
        STLM      A,BRC
        DLD       *SP(10),A ; ****
        NOP
        RPTB      LOOP32-1
       
L30:    
;----------------------------------------------------------------------
; 198 | sum = L_mac(sum, *p, *p);                                              
;----------------------------------------------------------------------
        LD        *AR1,B
        ;DLD       *SP(10),A            
        STLM      B,T
        ;ORM       #2,*(PMST)
        ;SSBX      FRCT
        ;SSBX      OVM
        ;ORM       #2,*(PMST)
        MAR       *+AR1(#2)
        MAC       *(BL), A              
        ;DST       A,*SP(10)              
LOOP32:
		DST       A,*SP(10)
L31:    

;----------------------------------------------------------------------
; 203 | sum = Inv_sqrt(sum);            /* 1/sqrt(energy),    result in Q30 */ 
;----------------------------------------------------------------------
        RSBX      OVM
        RSBX      FRCT
        DLD       *SP(10),A             ; |203| 
        CALL      #_Inv_sqrt            ; |203| 
       
        DST       A,*SP(10)             ; |203| 

;----------------------------------------------------------------------
; 204 | L_Extract(max, &max_h, &max_l);                                        
;----------------------------------------------------------------------
        ;RSBX      OVM
        ;RSBX      FRCT
        LDM       SP,A
        ADD       #6,A
        STL       A,*SP(0)
        LDM       SP,A
        ADD       #7,A
        STL       A,*SP(1)
        DLD       *FP(240),A            ; |204| 
        CALL      #_L_Extract           ; |204| 

;----------------------------------------------------------------------
; 205 | L_Extract(sum, &ener_h, &ener_l);                                      
;----------------------------------------------------------------------
        ;RSBX      OVM
        LDM       SP,A
        ADD       #8,A
        STL       A,*SP(0)
        LDM       SP,A
        ADD       #9,A
        STL       A,*SP(1)
        ;RSBX      FRCT
        DLD       *SP(10),A             ; |205| 
        CALL      #_L_Extract           ; |205| 

;----------------------------------------------------------------------
; 206 | sum  = Mpy_32(max_h, max_l, ener_h, ener_l);                           
;----------------------------------------------------------------------
        LD        *SP(7),A
        STL       A,*SP(0)
        ;RSBX      FRCT
        LD        *SP(8),A
        STL       A,*SP(1)
        LD        *SP(9),A
        STL       A,*SP(2)
        ;RSBX      OVM
        LD        *SP(6),A
        CALL      #_Mpy_32              ; |206| 
        
        DST       A,*SP(10)             ; |206| 

;----------------------------------------------------------------------
; 207 | max3 = extract_l(sum);                                                 
;----------------------------------------------------------------------
        MVDK      *SP(11),*(AR6)

;----------------------------------------------------------------------
; 216 | i = sub(shl(T2,1), T3);                                                
; 217 | j = sub(abs_s(i), 5);                                                  
;----------------------------------------------------------------------
        SSBX      SXM    ; ****
        SSBX      OVM    ; ****
        NOP
        ;ST        #1,*SP(0)             ; |216| 
        ;RSBX      FRCT
        ;RSBX      OVM
        LD        *FP(243),A
        ;CALL      #_clshft              ; |216| 
        SFTA      A,1
        
        ;RSBX      OVM
        LD        *FP(244),B
        ;SSBX      SXM
        LD        *(AL),16,A            ; |216| 
        ;SSBX      OVM
        SUB       *(BL),16,A,A          ; |216| 
        SFTA      A,-16,A               ; |216| 
        STLM      A,AR1

;----------------------------------------------------------------------
; 218 | if(j < 0)                                                              
;----------------------------------------------------------------------
        ;RSBX      OVM
        LD        *(AR1),16,A           ; |218| 
        ;SSBX      OVM
        NOP
        ABS       A,A                   ; |218| 
        SFTA      A,-16,A               ; |218| 
        ;RSBX      OVM
        LD        *(AL),A               ; |218| 
        SUB       #5,A,A                ; |218| 
        BC        L32,AGEQ              ; |218| 

;----------------------------------------------------------------------
; 219 | max2 = add(max2, shr(max3, 2));                                        
;----------------------------------------------------------------------
        ;ST        #2,*SP(0)             ; |219| 
        ;RSBX      FRCT
        LD        *SP(11),A
        ;CALL      #_shr              ; |219| 
        SFTA      A,-2
        
        ;SSBX      SXM
        ;RSBX      OVM
        LD        *FP(237),B
        LD        *(BL),16,B            ; |219| 
        ;SSBX      OVM
        ADD       *(AL),16,B,A          ; |219| 
        SFTA      A,-16,A               ; |219| 
        STL       A,*FP(237)
L32:    

;----------------------------------------------------------------------
; 224 | i = add(i, T2);                                                        
; 225 | j = sub(abs_s(i), 7);                                                  
;----------------------------------------------------------------------
        ;RSBX      OVM
        LD        *FP(243),B
        LD        *(AR1),16,A           ; |224| 
        ;SSBX      OVM
        ADD       *(BL),16,A,A          ; |224| 
        SFTA      A,-16,A               ; |224| 
        STLM      A,AR1

;----------------------------------------------------------------------
; 226 | if(j < 0)                                                              
;----------------------------------------------------------------------
        ;RSBX      OVM
        LD        *(AR1),16,A           ; |226| 
        ;SSBX      OVM
        NOP
        ABS       A,A                   ; |226| 
        SFTA      A,-16,A               ; |226| 
        ;RSBX      OVM
        LD        *(AL),A               ; |226| 
        SUB       #7,A,A                ; |226| 
        BC        L33,AGEQ              ; |226| 

;----------------------------------------------------------------------
; 227 | max2 = add(max2, shr(max3, 2));                                        
;----------------------------------------------------------------------
        ;RSBX      FRCT
        ;ST        #2,*SP(0)             ; |227| 
        ;CALLD     #_shr              ; |227| 
        ;NOP
        LDM       AR6,A
        NOP
        SFTA      A,-2
        
        ;SSBX      SXM
        ;RSBX      OVM
        LD        *FP(237),B
        LD        *(BL),16,B            ; |227| 
        ;SSBX      OVM
        ADD       *(AL),16,B,A          ; |227| 
        SFTA      A,-16,A               ; |227| 
        STL       A,*FP(237)
L33:    

;----------------------------------------------------------------------
; 232 | i = sub(shl(T1,1), T2);                                                
; 233 | j = sub(abs_s(i), 5);                                                  
;----------------------------------------------------------------------
        ;ST        #1,*SP(0)             
        ;RSBX      FRCT
        ;RSBX      OVM
        LD        *FP(242),A
        ;CALL      #_clshft              
        SFTA      A,1
        
        ;SSBX      SXM
        ;RSBX      OVM
        LD        *FP(243),B
        LD        *(AL),16,A           
        ;SSBX      OVM
        SUB       *(BL),16,A,A          
        SFTA      A,-16,B               

;----------------------------------------------------------------------
; 234 | if(j < 0)                                                              
;----------------------------------------------------------------------
        ;RSBX      OVM
        LD        *(BL),16,A           
        ;SSBX      OVM
        NOP
        ABS       A,A                   
        ;RSBX      OVM
        SFTA      A,-16,A               
        LD        *(AL),A               
        SUB       #5,A,A                
        BC        L34,AGEQ              

;----------------------------------------------------------------------
; 235 | max1 = add(max1, mult(max2, 6554));                                    
;----------------------------------------------------------------------
        LD        #6554,16,A           
        SSBX      FRCT
        LD        *FP(237),T
        ;SSBX      OVM
        MVDK      *FP(238),*(AR2)
        MPYA      A                     ; |235| 
        ;RSBX      OVM
        SFTA      A,-16,A               ; |235| 
        STLM      A,AR1
        LD        *(AR2),16,A           ; |235| 
        ;SSBX      OVM
        ADD       *(AR1),16,A,A         ; |235| 
        SFTA      A,-16,A               ; |235| 
        STL       A,*FP(238)
L34:    

;----------------------------------------------------------------------
; 240 | i = add(i, T1);                                                        
; 241 | j = sub(abs_s(i), 7);                                                  
;----------------------------------------------------------------------
        ;RSBX      OVM
        LD        *(BL),16,A            ; |240| 
        LD        *FP(242),B
        ;SSBX      OVM
        ADD       *(BL),16,A,A          ; |240| 
        SFTA      A,-16,B               ; |240| 

;----------------------------------------------------------------------
; 242 | if(j < 0)                                                              
;----------------------------------------------------------------------
        ;RSBX      OVM
        LD        *(BL),16,A          
        ;SSBX      OVM
        NOP
        ABS       A,A                  
        ;RSBX      OVM
        SFTA      A,-16,A              
        LD        *(AL),A              
        SUB       #7,A,A               
        BC        L35,AGEQ             

;----------------------------------------------------------------------
; 243 | max1 = add(max1, mult(max2, 6554));                                    
;----------------------------------------------------------------------
        LD        #6554,16,A           
        SSBX      FRCT
        LD        *FP(237),T
        ;SSBX      OVM
        LD        *FP(238),B
        MPYA      A                    
        ;RSBX      OVM
        LD        *(BL),16,B           
        ;SSBX      OVM
        SFTA      A,-16,A              
        ADD       *(AL),16,B,A         
        SFTA      A,-16,A               
        STL       A,*FP(238)
L35:    

;----------------------------------------------------------------------
; 249 | if( sub(max1, max2) < 0 ) {max1 = max2; T1 = T2;  }                    
;----------------------------------------------------------------------
        ;RSBX      OVM
        LD        *FP(238),A
        LD        *FP(237),B
        LD        *(AL),16,A           
        ;SSBX      OVM
        SUB       *(BL),16,A,A        
        SFTA      A,-16,A              
        LD        *(AL),A              
        BC        L36,AGEQ             

        LD        B,A
        STL       A,*FP(238)
        LD        *FP(243),A
        STL       A,*FP(242)
L36:    
;----------------------------------------------------------------------
; 250 | if( sub(max1, max3) <0 )  {T1 = T3; }                                  
;----------------------------------------------------------------------
        ;RSBX      OVM
        LD        *FP(238),A
        LD        *(AL),16,A           
        ;SSBX      OVM
        SUB       *(AR6),16,A,A         
        SFTA      A,-16,A               
        LD        *(AL),A               
        BC        L37,AGEQ             

        LD        *FP(244),A
        STL       A,*FP(242)
L37:    
;----------------------------------------------------------------------
; 252 | return T1;                                                             
;----------------------------------------------------------------------
        LD        *FP(242),A

        ANDM      #-833,*(ST1)          
        ANDM      #-4,*(PMST)           
        RSBX      OVM
        ADDM      #246,*(SP)            
        NOP
        NOP
        POPM      FP                    
        POPM      AR6                   
        POPM      AR1                   
        RET       
        
	.sect	".text"
	.global	_Dot_Product
_Dot_Product:
        SSBX      SXM
        MVDK      *SP(1),*(AR2)    ; ar2 = y
        LD        *SP(2),B         ; b = lg
        STLM      A,AR3            ; ar3 = x
        LD        #0,A
        SUB       #1,B,B
        STLM      B,BRC
        SSBX      FRCT
        SSBX      OVM
        ORM       #2,*(PMST)
        NOP
        RPTB      L39-1    
L38:    
        MAC       *AR2+, *AR3+, A, A    
L39:    
        ANDM      #-833,*(ST1)         
        ANDM      #-4,*(PMST)           
        RET      

	.sect	".text"
	.global	_G_pitch

;----------------------------------------------------------------------
; 373 | Word16 G_pitch(      /* (o) Q14 : Gain of pitch lag saturated to 1.2
;     |     */                                                                 
; 374 | Word16 xn[],       /* (i)     : Pitch target.
;     |   */                                                                   
; 375 | Word16 y1[],       /* (i)     : Filtered adaptive codebook.
;     |   */                                                                   
; 376 | Word16 g_coeff[],  /* (i)     : Correlations need for gain quantization
;     | . */                                                                   
; 377 | Word16 L_subfr     /* (i)     : Length of subframe.
;     |   */                                                                   
; 378 | )                                                                      
;----------------------------------------------------------------------

_G_pitch:
        PSHM      AR1
        PSHM      AR6
        PSHM      AR7
        FRAME     #-52
        NOP
        STL       A,*SP(48)          ; sp(48) = xn[]
        LD        *SP(58),A
        STL       A,*SP(49)          ; sp(49) = L_subfr
        LD        *SP(57),A
        STL       A,*SP(50)          ; sp(50) = g_coeff[]
        LD        *SP(56),A
        STL       A,*SP(51)          ; sp(51) = y1[]
;----------------------------------------------------------------------
; 388 | for(i=0; i<L_subfr; i++)                                               
;----------------------------------------------------------------------     
        SSBX      SXM
        SSBX      OVM
        NOP
        LD        *SP(49),A
        ;BC        L48,ALEQ            

        MVMM      SP,AR1
        MVDK      *SP(49),*(AR7)     ; ar7 = L_subfr
        MVDK      *SP(51),*(AR6)     ; ar6 = y1[]
        MAR       *+AR1(#8)          ; ar1 = scaled_y1[]
L47:    

;----------------------------------------------------------------------
; 389 | scaled_y1[i] = shr(y1[i], 2);                                          
;----------------------------------------------------------------------
        ;ST        #2,*SP(0)             
        ;RSBX      FRCT
        ;RSBX      OVM
        LD        *AR6+,A
        ;CALL      #_shr             
        SFTA      A,-2
        BANZD     L47,*+AR7(-1)        
        NOP
        STL       A,*AR1+
L48:    
        LD        *SP(51),A
        STL       A,*SP(0)
        ;RSBX      OVM
        STL       A,*SP(1)
        ;RSBX      FRCT
        LD        *SP(49),A
        ST        #0,*SP(2)              
        STL       A,*SP(3)
        LDM       SP,A
        ADD       #6,A
        ST        #1,*SP(4)             
        STL       A,*SP(5)
        CALLD     #_Verifi_Overflow     
        NOP
        LD        #1,A
        ; OVM = SXM = 1
        ;RSBX      OVM
        ;LD        *(AL),A               
        BC        L51,AEQ               

;----------------------------------------------------------------------
; 406 | s = 1;                  /* Avoid case of all zeros */                  
;----------------------------------------------------------------------
        LD        #1,A
        DST       A,*SP(6)              

;----------------------------------------------------------------------
; 407 | for(i=0; i<L_subfr; i++)                                               
;----------------------------------------------------------------------
        ;SSBX      SXM
        ;NOP
        LD        *SP(49),A
        ;BC        L50,ALEQ            

        ;LD        *SP(49),A
        MVMM      SP,AR1
        SUB       #1,A,A
        STLM      A,BRC
        MAR       *+AR1(#8)
        SSBX      FRCT                  ; ****
        ORM       #2,*(PMST)            ; ****
        DLD       *SP(6),A              ; ****
        RPTB      L50-1
L49:    
;----------------------------------------------------------------------
; 408 | s = L_mac(s, scaled_y1[i], scaled_y1[i]);                              
; 409 | exp_yy = norm_l(s);                                                    
;----------------------------------------------------------------------
        LD        *AR1+,B
        ;DLD       *SP(6),A              
        STLM      B,T
        ;ORM       #2,*(PMST)
        ;SSBX      FRCT
        ;SSBX      OVM
        ;ORM       #2,*(PMST)
        MAC       *(BL), A              
        ;DST       A,*SP(6)              
L50: 
		DST       A,*SP(6)    ; ****  
;----------------------------------------------------------------------
; 410 | yy     = round( L_shl(s, exp_yy) );                                    
;----------------------------------------------------------------------
        DLD       *SP(6),A             
        ;RSBX      OVM
        EXP       A                    
        RSBX      FRCT
        MVMD      T,AR1
        MVKD      *(AR1),*SP(0)
        DLD       *SP(6),A             
        CALL      #_L_shl               
   
        ;RSBX      OVM
        ;SSBX      SXM
        ;SFTA      A,8                   
        SSBX      OVM
        ;SFTA      A,-8
        NOP                  
        ADD       #1,#15,A,A            
        SFTA      A,-16,A               
        STLM      A,AR6
;----------------------------------------------------------------------
; 411 | exp_yy = sub(exp_yy, 4);                                               
;----------------------------------------------------------------------
        ;RSBX      OVM
        LD        *(AR1),16,A          
        ;SSBX      OVM
        ;NOP
        SUB       #4,16,A,A             
        SFTA      A,-16,A               
        BD        L52                   
        STLM      A,AR1
        NOP

L51:    
        SSBX      SXM
        NOP
        DLD       *SP(6),A
        EXP       A                     
        NOP
        MVMD      T,AR1

        RSBX      FRCT
        MVKD      *(AR1),*SP(0)
        DLD       *SP(6),A               
        CALL      #_L_shl               
  
        ;RSBX      OVM
        ;SSBX      SXM
        ;SFTA      A,8                   
        SSBX      OVM
        ;SFTA      A,-8   
        NOP              
        ADD       #1,#15,A,A            
        SFTA      A,-16,A               
        STLM      A,AR6
        NOP
L52:    
;----------------------------------------------------------------------
; 415 | if (Verifi_Overflow(0,xn,y1,0,L_subfr,1,&s)) {                         
; 416 |   exp_xy = norm_l(s);                                                  
; 417 |   xy     = round( L_shl(s, exp_xy) );                                  
; 419 | else {                                                                 
;----------------------------------------------------------------------
        LD        *SP(48),A
        STL       A,*SP(0)
        RSBX      OVM
        LD        *SP(51),A
        RSBX      FRCT
        STL       A,*SP(1)
        ST        #0,*SP(2)              
        LD        *SP(49),A
        STL       A,*SP(3)
        LDM       SP,A
        ADD       #6,A
        ST        #1,*SP(4)             
        STL       A,*SP(5)
        CALLD     #_Verifi_Overflow     
        NOP
        LD        #0,A
       
        STLM      A,AR2
        NOP
        NOP
;        BANZ      L55,*AR2  ; if(*AR2!=0) go to L55             
	BC      L55,AEQ      ;  if(A==0) goto L55 2005.8.19 dzc fix this bug     
;----------------------------------------------------------------------
; 420 | s = 0;                                                                 
;----------------------------------------------------------------------
        LD        #0,A
        DST       A,*SP(6)              ; |420| 

;----------------------------------------------------------------------
; 421 | for(i=0; i<L_subfr; i++)                                               
;----------------------------------------------------------------------
        SSBX      SXM
        NOP
        LD        *SP(49),A
        BC        L54,ALEQ              ; |421| 

        ;RSBX      OVM
        LD        *SP(49),A
        MVMM      SP,AR2
        MVDK      *SP(48),*(AR3)
        SUB       #1,A,A
        STLM      A,BRC
        MAR       *+AR2(#8)
        DLD       *SP(6),A
        SSBX      FRCT
        SSBX      OVM
        ORM       #2,*(PMST)
        RPTB      L54-1

L53:    
;----------------------------------------------------------------------
; 422 | s = L_mac(s, xn[i], scaled_y1[i]);                                     
; 423 | exp_xy = norm_l(s);                                                    
;----------------------------------------------------------------------
        ;DLD       *SP(6),A              
        ;ORM       #2,*(PMST)
        ;SSBX      FRCT
        ;SSBX      OVM
        ;ORM       #2,*(PMST)
        ;NOP
        MAC       *AR2+, *AR3+, A, A    
        ;DST       A,*SP(6)              
       
L54:    
        DST       A,*SP(6)
;----------------------------------------------------------------------
; 424 | xy     = round( L_shl(s, exp_xy) );                                    
;----------------------------------------------------------------------
        ;DLD       *SP(6),A              
        ;RSBX      OVM
        EXP       A                     
        RSBX      FRCT
        MVMD      T,AR7
        MVKD      *(AR7),*SP(0)
        DLD       *SP(6),A               
        CALL      #_L_shl               
       
        ;RSBX      OVM
        ;SSBX      SXM
        ;SFTA      A,8                   
        SSBX      OVM
        ;SFTA      A,-8                  
        ADD       #1,#15,A,A           
        SFTA      A,-16,A               

;----------------------------------------------------------------------
; 425 | exp_xy = sub(exp_xy, 2);                                               
;----------------------------------------------------------------------
        RSBX      OVM
        LD        *(AR7),16,B           
        SSBX      OVM
        NOP
        SUB       #2,16,B,B             
        SFTA      B,-16,B               
        BD        L56                   
        STLM      B,AR7
        NOP
        
L55:    
        SSBX      SXM
        NOP
        DLD       *SP(6),A
        EXP       A                     
        NOP
        MVMD      T,AR7

        RSBX      OVM
        RSBX      FRCT
        MVKD      *(AR7),*SP(0)
        DLD       *SP(6),A             
        CALL      #_L_shl              
        
        RSBX      OVM
        SSBX      SXM
        SFTA      A,8                   
        SSBX      OVM
        SFTA      A,-8                 
        ADD       #1,#15,A,A            
        SFTA      A,-16,A               
L56:    
;----------------------------------------------------------------------
; 428 | g_coeff[0] = yy;                                                       
;----------------------------------------------------------------------
        MVDK      *SP(50),*(AR2)
        MVKD      *(AR6),*AR2

;----------------------------------------------------------------------
; 429 | g_coeff[1] = sub(15, exp_yy);                                          
;----------------------------------------------------------------------
        RSBX      OVM
        NOP
        LD        #15,16,B              ; |429| 
        SSBX      OVM
        SUB       *(AR1),16,B,B         ; |429| 
        STH       B,*AR2(1)             ; |429| 

;----------------------------------------------------------------------
; 430 | g_coeff[2] = xy;                                                       
;----------------------------------------------------------------------
        STL       A,*AR2(2)

;----------------------------------------------------------------------
; 431 | g_coeff[3] = sub(15, exp_xy);                                          
;----------------------------------------------------------------------
        RSBX      OVM
        NOP
        LD        #15,16,B              ; |431| 
        SSBX      OVM
        SUB       *(AR7),16,B,B         ; |431| 
        STH       B,*AR2(3)             ; |431| 

;----------------------------------------------------------------------
; 436 | if (xy <= 0)                                                           
;----------------------------------------------------------------------
        LD        *(AL),A               ; |436| 
        BC        L57,AGT               ; |436| 

;----------------------------------------------------------------------
; 438 | g_coeff[3] = -15;   /* Force exp_xy to -15 = (15-30) */                
;----------------------------------------------------------------------
        MVMM      AR2,AR1
        ST        #-15,*AR1(3)          ; |438| 
;----------------------------------------------------------------------
; 439 | return( (Word16) 0);                                                   
;----------------------------------------------------------------------
        BD        L59                   ; |439| 
        NOP
        LD        #0,A
L57:    
;----------------------------------------------------------------------
; 444 | xy = shr(xy, 1);             /* Be sure xy < yy */                     
;----------------------------------------------------------------------
        RSBX      FRCT
        RSBX      OVM
        ST        #1,*SP(0)             ; |444| 
        CALL      #_shr              ; |444| 

;----------------------------------------------------------------------
; 445 | gain = div_s( xy, yy);                                                 
; 447 | i = sub(exp_xy, exp_yy);                                               
;----------------------------------------------------------------------
        RSBX      FRCT
        RSBX      OVM
        MVKD      *(AR6),*SP(0)
        CALL      #_divs                ; |445| 

;----------------------------------------------------------------------
; 448 | gain = shr(gain, i);         /* saturation if > 1.99 in Q14 */         
; 452 | if( sub(gain, 19661) > 0)                                              
;----------------------------------------------------------------------
        SSBX      SXM
        RSBX      OVM
        LD        *(AR7),16,B           
        SSBX      OVM
        SUB       *(AR1),16,B,B         
        RSBX      FRCT
        RSBX      OVM
        STH       B,*SP(0)              
        CALL      #_shr              

        SSBX      SXM
        RSBX      OVM
        LD        *(AL),B              
        SUB       #19662,B,B             
        BC        L58,BLT               
;----------------------------------------------------------------------
; 454 | gain = 19661;                                                          
;----------------------------------------------------------------------
        LD        #19661,A
L58:    
;----------------------------------------------------------------------
; 458 | return(gain);                                                          
;----------------------------------------------------------------------
L59:    

        ANDM      #-833,*(ST1)          ; |458| 
        ANDM      #-4,*(PMST)           ; |458| 
        FRAME     #52                   ; |458| 
        POPM      AR7                   ; |458| 
        POPM      AR6                   ; |458| 
        POPM      AR1                   ; |458| 
        RET       

	.sect	".text"
	.global	_Enc_lag3
;----------------------------------------------------------------------
; 489 | Word16 Enc_lag3(     /* output: Return index of encoding */            
; 490 | Word16 T0,         /* input : Pitch delay              */              
; 491 | Word16 T0_frac,    /* input : Fractional pitch delay   */              
; 492 | Word16 *T0_min,    /* in/out: Minimum search delay     */              
; 493 | Word16 *T0_max,    /* in/out: Maximum search delay     */              
; 494 | Word16 pit_min,    /* input : Minimum pitch delay      */              
; 495 | Word16 pit_max,    /* input : Maximum pitch delay      */              
; 496 | Word16 pit_flag    /* input : Flag for 1st subframe    */              
; 497 | )                                                                      
;----------------------------------------------------------------------
_Enc_lag3:

        PSHM      AR1
        NOP
        MVDK      *SP(2),*(AR5)
        MVDK      *SP(3),*(AR1)
        MVDK      *SP(4),*(AR3)
        MVDK      *SP(5),*(AR4)
        MVDK      *SP(7),*(AR0)
        MVDK      *SP(6),*(AR2)

;----------------------------------------------------------------------
; 501 | if (pit_flag == 0)   /* if 1st subframe */                             
;----------------------------------------------------------------------
        BANZ      L63,*AR0              ; |501| 
;----------------------------------------------------------------------
; 505 | if (sub(T0, 85) <= 0)                                                  
; 508 |   i = add(add(T0, T0), T0);                                            
; 509 |   index = add(sub(i, 58), T0_frac);                                    
;----------------------------------------------------------------------
        SSBX      SXM
        RSBX      OVM
        LD        *(AL),B               
        SUB       #86,B,B               
        BC        L60,BGEQ              
        
        LD        *(AL),16,B            ; |505| 
        SSBX      OVM
        ADD       *(AL),16,B,B          ; |505| 
        ADD       *(AL),16,B,B          ; |505| 
        SUB       #58,16,B,B            ; |505| 
        ADD       *(AR5),16,B,B         ; |505| 
        BD        L61                   ; |505| 
        SFTA      B,-16,B               ; |505| 
        STLM      B,AR5
       
L60:    
        LD        *(AL),16,B            ; |505| 
        SSBX      OVM
        NOP
        ADD       #112,16,B,B           ; |505| 
        SFTA      B,-16,B               ; |505| 
        STLM      B,AR5
L61:    
;----------------------------------------------------------------------
; 511 | else {                                                                 
; 512 |   index = add(T0, 112);                                                
; 517 | *T0_min = sub(T0, 5);                                                  
;----------------------------------------------------------------------
        RSBX      OVM
        LD        *(AL),16,B            ; |510| 
        SSBX      OVM
        NOP
        SUB       #5,16,B,B             ; |510| 
        SFTA      B,-16,B               ; |510| 
        STL       B,*AR1

;----------------------------------------------------------------------
; 518 | if (sub(*T0_min, pit_min) < 0)                                         
;----------------------------------------------------------------------
        RSBX      OVM
        LD        *(BL),16,A            ; |518| 
        SSBX      OVM
        SUB       *(AR4),16,A,A         ; |518| 
        SFTA      A,-16,A               ; |518| 
        LD        *(AL),A               ; |518| 
        BC        L62,AGEQ              ; |518| 

;----------------------------------------------------------------------
; 520 | *T0_min = pit_min;                                                     
;----------------------------------------------------------------------
        LDM       AR4,B
        STL       B,*AR1
L62:    
;----------------------------------------------------------------------
; 523 | *T0_max = add(*T0_min, 9);                                             
;----------------------------------------------------------------------
        RSBX      OVM
        LD        *(BL),16,B            ; |523| 
        SSBX      OVM
        NOP
        ADD       #9,16,B,B             ; |523| 
        SFTA      B,-16,B               ; |523| 
        STL       B,*AR3

;----------------------------------------------------------------------
; 524 | if (sub(*T0_max, pit_max) > 0)                                         
;----------------------------------------------------------------------
        RSBX      OVM
        LD        *(BL),16,B            ; |524| 
        SSBX      OVM
        SUB       *(AR2),16,B,B         ; |524| 
        SFTA      B,-16,B               ; |524| 
        LD        *(BL),B               ; |524| 
        BC        L64,BLEQ              ; |524| 

;----------------------------------------------------------------------
; 526 | *T0_max = pit_max;                                                     
;----------------------------------------------------------------------
        MVKD      *(AR2),*AR3

;----------------------------------------------------------------------
; 527 | *T0_min = sub(*T0_max, 9);                                             
; 530 | else      /* if second subframe */                                     
; 535 | i = sub(T0, *T0_min);                                                  
; 536 | i = add(add(i, i), i);                                                 
;----------------------------------------------------------------------
        RSBX      OVM
        LD        *(AR2),16,B           ; |527| 
        SSBX      OVM
        NOP
        SUB       #9,16,B,B             ; |527| 
        BD        L65                   ; |527| 
        LDM       AR5,A
        STH       B,*AR1                ; |527| 
        
L63:    

;----------------------------------------------------------------------
; 537 | index = add(add(i, 2), T0_frac);                                       
;----------------------------------------------------------------------
        RSBX      OVM
        SSBX      SXM
        LD        *(AL),16,A            ; |537| 
        SSBX      OVM
        NOP
        SUB       *AR1,16,A,A           ; |537| 
        RSBX      OVM
        SFTA      A,-16,A               ; |537| 
        LD        *(AL),16,B            ; |537| 
        SSBX      OVM
        ADD       *(AL),16,B,B          ; |537| 
        ADD       *(AL),16,B,A          ; |537| 
        ADD       #2,16,A,A             ; |537| 
        ADD       *(AR5),16,A,A         ; |537| 
        SFTA      A,-16,A               ; |537| 
        STLM      A,AR5
        NOP
L64:    
        LDM       AR5,A
L65:    
        ANDM      #-833,*(ST1)          ; |541| 
        ANDM      #-4,*(PMST)           ; |541| 
        POPM      AR1                   ; |541| 
        RET       

;***************************************************************
;* UNDEFINED EXTERNAL REFERENCES                               *
;***************************************************************
	.global	_Pred_lt_3
	.global	_L_shl
	.global	_L_Extract
	.global	_Mpy_32
	.global	_Inv_sqrt
	.global	_Cor_h_X
	.global	_Verifi_Overflow
	.global	_shr
	.global	_divs

